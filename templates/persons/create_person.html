{% extends 'persons/base.html' %}

{% block title %}Добавить человека{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="mb-4">Добавить нового человека</h2>
        
        <div id="alert-container"></div>
        
        <form id="person-form">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="last_name" class="form-label">Фамилия *</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" required>
                        <div class="form-text">Кириллица, начинается с большой буквы, минимум 2 символа</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="first_name" class="form-label">Имя *</label>
                        <input type="text" class="form-control" id="first_name" name="first_name" required>
                        <div class="form-text">Кириллица, начинается с большой буквы, минимум 2 символа</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="middle_name" class="form-label">Отчество</label>
                        <input type="text" class="form-control" id="middle_name" name="middle_name">
                        <div class="form-text">Опционально, кириллица</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="birth_date" class="form-label">Дата рождения *</label>
                        <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="gender" class="form-label">Пол *</label>
                <select class="form-control" id="gender" name="gender" required>
                    <option value="">Выберите пол</option>
                    <option value="М">Мужской</option>
                    <option value="Ж">Женский</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="address" class="form-label">Адрес *</label>
                <div class="position-relative">
                    <textarea class="form-control" id="address" name="address" rows="3" required 
                              placeholder="Начните вводить адрес для получения подсказок..."
                              autocomplete="off"></textarea>
                    <div id="address-suggestions" class="position-absolute w-100 bg-white border border-top-0 d-none" 
                         style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="phone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="phone" name="phone" placeholder="89123456789">
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                        <div class="form-text">Формат: login@domain</div>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary me-md-2" onclick="location.href='/'">Отмена</button>
                <button type="submit" class="btn btn-primary">Добавить человека</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('person-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Очистка пустых значений
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            delete data[key];
        }
    });
    
    try {
        const response = await fetch('/api/persons/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `Человек успешно добавлен! ID: ${result.person_id}, Группа: ${result.group_id}`);
            this.reset();
        } else {
            let errorMessage = 'Ошибки валидации:\n';
            if (result.errors) {
                for (const [field, errors] of Object.entries(result.errors)) {
                    errorMessage += `${field}: ${errors.join(', ')}\n`;
                }
            } else {
                errorMessage = result.error || 'Неизвестная ошибка';
            }
            showAlert('danger', errorMessage);
        }
    } catch (error) {
        showAlert('danger', 'Ошибка сети: ' + error.message);
    }
});

function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message.replace(/\n/g, '<br>')}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

// Автозаполнение адреса через DaData
let addressTimeout;
const addressInput = document.getElementById('address');
const suggestionsDiv = document.getElementById('address-suggestions');

addressInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(addressTimeout);
    
    if (query.length < 3) {
        hideSuggestions();
        return;
    }
    
    addressTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/address/suggestions/?query=${encodeURIComponent(query)}&count=5`);
            const data = await response.json();
            
            if (data.success && data.suggestions.length > 0) {
                showSuggestions(data.suggestions);
            } else {
                hideSuggestions();
            }
        } catch (error) {
            console.error('Ошибка при получении подсказок адреса:', error);
            hideSuggestions();
        }
    }, 300); // Задержка 300мс перед запросом
});

function showSuggestions(suggestions) {
    let html = '';
    suggestions.forEach((suggestion, index) => {
        html += `
            <div class="suggestion-item p-2 border-bottom cursor-pointer" 
                 data-address="${suggestion.value}"
                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                 onmouseout="this.style.backgroundColor='white'"
                 onclick="selectAddress('${suggestion.value.replace(/'/g, "\\'")}')">
                <div class="fw-bold">${suggestion.value}</div>
                ${suggestion.data.postal_code ? `<small class="text-muted">Индекс: ${suggestion.data.postal_code}</small>` : ''}
            </div>
        `;
    });
    
    suggestionsDiv.innerHTML = html;
    suggestionsDiv.classList.remove('d-none');
}

function selectAddress(address) {
    addressInput.value = address;
    hideSuggestions();
}

function hideSuggestions() {
    suggestionsDiv.classList.add('d-none');
}

// Скрытие подсказок при клике вне поля
document.addEventListener('click', function(e) {
    if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        hideSuggestions();
    }
});

// Навигация по подсказкам клавишами
addressInput.addEventListener('keydown', function(e) {
    const items = suggestionsDiv.querySelectorAll('.suggestion-item');
    if (items.length === 0) return;
    
    let activeIndex = -1;
    items.forEach((item, index) => {
        if (item.style.backgroundColor === 'rgb(13, 110, 253)') {
            activeIndex = index;
        }
    });
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        highlightItem(items, activeIndex);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = activeIndex <= 0 ? items.length - 1 : activeIndex - 1;
        highlightItem(items, activeIndex);
    } else if (e.key === 'Enter' && activeIndex >= 0) {
        e.preventDefault();
        selectAddress(items[activeIndex].dataset.address);
    } else if (e.key === 'Escape') {
        hideSuggestions();
    }
});

function highlightItem(items, activeIndex) {
    items.forEach((item, index) => {
        if (index === activeIndex) {
            item.style.backgroundColor = '#0d6efd';
            item.style.color = 'white';
        } else {
            item.style.backgroundColor = 'white';
            item.style.color = 'black';
        }
    });
}
</script>
{% endblock %}
