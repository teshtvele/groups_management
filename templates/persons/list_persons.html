{% extends 'persons/base.html' %}

{% block title %}–í–∏—Ç—Ä–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ –∏ —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"> –í–∏—Ç—Ä–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ –ª—é–¥–µ–π</h2>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –∏ –∏—Ö –∏—Å—Ç–æ—Ä–∏–µ–π -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-info" onclick="showGroupsModal()">
                            <i class="fas fa-users"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –≥—Ä—É–ø–ø
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="number" class="form-control" id="groupIdInput" placeholder="ID –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1)" min="1">
                            <button type="button" class="btn btn-outline-success" onclick="showGroupHistoryByIdFromInput()">
                                <i class="fas fa-search"></i> –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø—ã
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ü–æ–∏—Å–∫</h5>
            </div>
            <div class="card-body">
                <form id="searchForm" class="row g-3">
                    <div class="col-md-2">
                        <label for="last_name" class="form-label">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" 
                               placeholder="–ò–≤–∞–Ω–æ–≤...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="first_name" class="form-label">–ò–º—è</label>
                        <input type="text" class="form-control" id="first_name" name="first_name" 
                               placeholder="–ò–≤–∞–Ω...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="middle_name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                        <input type="text" class="form-control" id="middle_name" name="middle_name" 
                               placeholder="–ò–≤–∞–Ω–æ–≤–∏—á...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="address" class="form-label">–ê–¥—Ä–µ—Å</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="address" name="address" 
                                   placeholder="–ú–æ—Å–∫–≤–∞..." autocomplete="off">
                            <div id="search-address-suggestions" class="position-absolute w-100 bg-white border border-top-0 d-none" 
                                 style="z-index: 1000; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="form-control" id="phone" name="phone" 
                               placeholder="8915...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" 
                               placeholder="@gmail.com">
                    </div>
                    
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-search"></i> –ü–æ–∏—Å–∫ –≤ –≤–∏—Ç—Ä–∏–Ω–µ
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearSearch()">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-info" onclick="showAllPersons()">
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö
                        </button>
                        <span id="resultsInfo" class="ms-3 text-muted"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫ -->
        <div id="loading" class="text-center d-none mb-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
        
        <div id="error" class="alert alert-danger d-none"></div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="resultsContainer">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤—Å–µ–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
            {% if persons %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</h5>
                    <span class="badge bg-info">–í—Å–µ–≥–æ: {{ persons|length }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortTable(0)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ ID">
                                        ID <i class="fas fa-sort"></i>
                                    </th>
                                    <th style="cursor: pointer;" onclick="sortTable(1)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≥—Ä—É–ø–ø–µ (–¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è)">
                                        –ì—Ä—É–ø–ø–∞ <i class="fas fa-sort"></i>
                                    </th>
                                    <th style="cursor: pointer;" onclick="sortTable(2)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ–∞–º–∏–ª–∏–∏">
                                        –§–ò–û <i class="fas fa-sort"></i>
                                    </th>
                                    <th>–ü–æ–ª</th>
                                    <th style="cursor: pointer;" onclick="sortTable(4)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è">
                                        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è <i class="fas fa-sort"></i>
                                    </th>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>Email</th>
                                    <th>–°–æ–∑–¥–∞–Ω</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for person in persons %}
                                <tr>
                                    <td>{{ person.id }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ person.group.id }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ person.last_name }} {{ person.first_name }}</strong>
                                        {% if person.middle_name %} {{ person.middle_name }}{% endif %}
                                    </td>
                                    <td>
                                        {% if person.gender == '–ú' %}
                                            <span class="badge bg-info">–ú—É–∂—Å–∫–æ–π</span>
                                        {% else %}
                                            <span class="badge bg-warning">–ñ–µ–Ω—Å–∫–∏–π</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ person.birth_date|date:"d.m.Y" }}</td>
                                    <td>
                                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="{{ person.address }}">
                                            {{ person.address }}
                                        </div>
                                    </td>
                                    <td>{{ person.phone|default:"-" }}</td>
                                    <td>{{ person.email|default:"-" }}</td>
                                    <td>{{ person.created_at|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <h4>–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                <p>–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.</p>
                <a href="/create/" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞</a>
            </div>
            {% endif %}
        </div>
        
        <div class="mt-4">
            <a href="/" class="btn btn-outline-primary">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/create/" class="btn btn-outline-success">+ –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞</a>
        </div>
    </div>
</div>

<script>
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
    async function showGroupHistoryById(groupId) {
        try {
            // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
            const timestamp = new Date().getTime();
            const response = await fetch(`/api/groups/${groupId}/history/?t=${timestamp}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                displayGroupHistoryModal(`${groupId}`, data.history, groupId);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –≥—Ä—É–ø–ø—ã: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –≥—Ä—É–ø–ø—ã: ' + error.message);
        }
    }

    function showGroupAtTimeFormById(groupId) {
        let html = `
            <div class="modal fade" id="atTimeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"> –°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã ${groupId} –Ω–∞ –¥–∞—Ç—É</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="timestampInput" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</label>
                                <input type="datetime-local" class="form-control" id="timestampInput" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            <button type="button" class="btn btn-primary" onclick="viewGroupAtTimeById(${groupId})">
                                <i class="fas fa-search"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å—Ç–∞–≤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('atTimeModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('atTimeModal'));
        modal.show();
    }

    async function viewGroupAtTimeById(groupId) {
        const timestamp = document.getElementById('timestampInput').value;
        if (!timestamp) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
            return;
        }
        
        try {
            const isoTimestamp = new Date(timestamp).toISOString();
            const response = await fetch(`/api/groups/${groupId}/at-time/?timestamp=${isoTimestamp}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
                const modal = bootstrap.Modal.getInstance(document.getElementById('atTimeModal'));
                modal.hide();
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
                let members = [];
                if (data.members) {
                    // –¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã
                    members = data.members;
                } else if (data.data && data.data.person) {
                    // –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å
                    members = [data.data.person];
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                displayGroupAtTimeModal(`${groupId}`, data.timestamp || timestamp, members);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–∞–≤–∞ –≥—Ä—É–ø–ø—ã: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–∞–≤–∞ –≥—Ä—É–ø–ø—ã: ' + error.message);
        }
    }

    const searchForm = document.getElementById('searchForm');
    const resultsContainer = document.getElementById('resultsContainer');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const resultsInfo = document.getElementById('resultsInfo');

    // –ü–æ–∏—Å–∫ –≤ –≤–∏—Ç—Ä–∏–Ω–µ
    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadingDiv.classList.remove('d-none');
        errorDiv.classList.add('d-none');
        resultsInfo.textContent = '';
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = new FormData(searchForm);
        const params = new URLSearchParams();
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                params.append(key, value);
            }
        }
        
        try {
            const response = await fetch(`/api/persons/search/?${params.toString()}`);
            const data = await response.json();
            
            loadingDiv.classList.add('d-none');
            
            if (data.success) {
                displaySearchResults(data.data, data.count);
                resultsInfo.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${data.count} –¥–µ–¥—É–±–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`;
                resultsInfo.className = 'ms-3 text-success';
            } else {
                showError(data.errors || data.error);
            }
        } catch (error) {
            loadingDiv.classList.add('d-none');
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
        }
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    function displaySearchResults(results, count) {
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning text-center">
                    <h4>–ü–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö"</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ –≤–∏—Ç—Ä–∏–Ω–µ</h5>
                    <span class="badge bg-success">–ù–∞–π–¥–µ–Ω–æ: ${count}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortSearchTable(0)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≥—Ä—É–ø–ø–µ">
                                        –ì—Ä—É–ø–ø–∞ <i class="fas fa-sort"></i>
                                    </th>
                                    <th style="cursor: pointer;" onclick="sortSearchTable(1)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ–∞–º–∏–ª–∏–∏">
                                        –§–ò–û <i class="fas fa-sort"></i>
                                    </th>
                                    <th>–ü–æ–ª</th>
                                    <th style="cursor: pointer;" onclick="sortSearchTable(3)" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è">
                                        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è <i class="fas fa-sort"></i>
                                    </th>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>Email</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        results.forEach(person => {
            const fullName = `${person.last_name} ${person.first_name} ${person.middle_name || ''}`.trim();
            const genderBadge = person.gender === '–ú' ? 
                '<span class="badge bg-info">–ú—É–∂—Å–∫–æ–π</span>' : 
                '<span class="badge bg-warning">–ñ–µ–Ω—Å–∫–∏–π</span>';
            
            html += `
                <tr>
                    <td><span class="badge bg-primary">${person.group_id}</span></td>
                    <td><strong>${fullName}</strong></td>
                    <td>${genderBadge}</td>
                    <td>${person.birth_date}</td>
                    <td>
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${person.address}">
                            ${person.address}
                        </div>
                    </td>
                    <td>${person.phone || '-'}</td>
                    <td>${person.email || '-'}</td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        resultsContainer.innerHTML = html;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
    function showAllPersons() {
        location.reload();
    }

    // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ–∏—Å–∫–∞
    function clearSearch() {
        searchForm.reset();
        resultsInfo.textContent = '';
        resultsInfo.className = 'ms-3 text-muted';
        errorDiv.classList.add('d-none');
        location.reload();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(error) {
        errorDiv.classList.remove('d-none');
        if (typeof error === 'object') {
            let errorText = '–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\\n';
            for (let field in error) {
                errorText += `${field}: ${error[field].join(', ')}\\n`;
            }
            errorDiv.textContent = errorText;
        } else {
            errorDiv.textContent = error;
        }
        resultsInfo.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ';
        resultsInfo.className = 'ms-3 text-danger';
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –≤ —Ñ–æ—Ä–º–µ –ø–æ–∏—Å–∫–∞
    let searchAddressTimeout;
    const searchAddressInput = document.getElementById('address');
    const searchSuggestionsDiv = document.getElementById('search-address-suggestions');

    if (searchAddressInput) {
        searchAddressInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchAddressTimeout);
            
            if (query.length < 3) {
                hideSearchSuggestions();
                return;
            }
            
            searchAddressTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/address/suggestions/?query=${encodeURIComponent(query)}&count=5`);
                    const data = await response.json();
                    
                    if (data.success && data.suggestions.length > 0) {
                        showSearchSuggestions(data.suggestions);
                    } else {
                        hideSearchSuggestions();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∞–¥—Ä–µ—Å–∞:', error);
                    hideSearchSuggestions();
                }
            }, 300);
        });

        // –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
        document.addEventListener('click', function(e) {
            if (!searchAddressInput.contains(e.target) && !searchSuggestionsDiv.contains(e.target)) {
                hideSearchSuggestions();
            }
        });
    }

    function showSearchSuggestions(suggestions) {
        let html = '';
        suggestions.forEach((suggestion) => {
            html += `
                <div class="search-suggestion-item p-2 border-bottom cursor-pointer" 
                     style="cursor: pointer;"
                     onmouseover="this.style.backgroundColor='#f8f9fa'"
                     onmouseout="this.style.backgroundColor='white'"
                     onclick="selectSearchAddress('${suggestion.value.replace(/'/g, "\\'")}')">
                    <div>${suggestion.value}</div>
                </div>
            `;
        });
        
        searchSuggestionsDiv.innerHTML = html;
        searchSuggestionsDiv.classList.remove('d-none');
    }

    function selectSearchAddress(address) {
        searchAddressInput.value = address;
        hideSearchSuggestions();
    }

    function hideSearchSuggestions() {
        searchSuggestionsDiv.classList.add('d-none');
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
    async function showGroupsModal() {
        try {
            const response = await fetch('/api/persistency/groups/');
            const data = await response.json();
            
            if (data.success) {
                displayGroupsModal(data.groups);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä—É–ø–ø: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä—É–ø–ø: ' + error.message);
        }
    }

    function displayGroupsModal(groups) {
        let html = `
            <div class="modal fade" id="groupsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üìã –í—Å–µ –≥—Ä—É–ø–ø—ã –≤ —Å–∏—Å—Ç–µ–º–µ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                                            <th>–°–æ–∑–¥–∞–Ω–∞</th>
                                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        groups.forEach(group => {
            html += `
                <tr>
                    <td><strong>${group.name}</strong></td>
                    <td><span class="badge bg-primary">${group.member_count}</span></td>
                    <td>${new Date(group.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="showGroupHistoryById(${group.id})">
                            <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('groupsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('groupsModal'));
        modal.show();
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π —É–¥–∞–ª–µ–Ω—ã
    // async function showChangesetsModal() { ... }
    // function displayChangesetsModal(changesets) { ... }
    // async function viewChangesetDetails(changesetId) { ... }
    // function displayChangesetDetailsModal(details) { ... }

    async function showGroupHistoryModal() {
        const groupName = document.getElementById('groupNameInput').value.trim();
        if (!groupName) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
            return;
        }
        
        try {
            const response = await fetch(`/api/persistency/groups/${encodeURIComponent(groupName)}/history/`);
            const data = await response.json();
            
            if (data.success) {
                displayGroupHistoryModal(data.group_name, data.history);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –≥—Ä—É–ø–ø—ã: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –≥—Ä—É–ø–ø—ã: ' + error.message);
        }
    }

    function displayGroupHistoryModal(groupName, history, groupId = null) {
        let html = `
            <div class="modal fade" id="groupHistoryModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"> –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø—ã ${groupName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
        `;
        
        if (history.length === 0) {
            html += `<div class="alert alert-info">–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã ${groupName} –ø—É—Å—Ç–∞.</div>`;
        } else {
            html += `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                                <th>–ß–µ–ª–æ–≤–µ–∫</th>
                                <th>–ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            history.forEach(record => {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è
                const validToDisplay = record.valid_to === '—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è' 
                    ? '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è' 
                    : `–¥–æ ${new Date(record.valid_to).toLocaleString()}`;
                
                html += `
                    <tr>
                        <td>${new Date(record.timestamp).toLocaleString()}</td>
                        <td><strong>${record.name}</strong></td>
                        <td>
                            <small class="text-muted">—Å ${new Date(record.valid_from).toLocaleString()}<br>${validToDisplay}</small>
                        </td>
                        <td>${record.reason || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        html += `
                        </div>
                        <div class="modal-footer">`;
        
        if (groupId) {
            html += `<button type="button" class="btn btn-outline-info" onclick="showGroupAtTimeFormById(${groupId})">
                        <i class="fas fa-clock"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å—Ç–∞–≤ –Ω–∞ –¥–∞—Ç—É
                     </button>`;
        } else {
            html += `<button type="button" class="btn btn-outline-info" onclick="showGroupAtTimeForm('${groupName}')">
                        <i class="fas fa-clock"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å—Ç–∞–≤ –Ω–∞ –¥–∞—Ç—É
                     </button>`;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('groupHistoryModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('groupHistoryModal'));
        modal.show();
    }

    function showGroupAtTimeForm(groupName) {
        const html = `
            <div class="modal fade" id="groupAtTimeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"> –°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã "${groupName}" –Ω–∞ –¥–∞—Ç—É</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="timestampInput" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</label>
                                <input type="datetime-local" class="form-control" id="timestampInput">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="viewGroupAtTime('${groupName}')">
                                –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('groupAtTimeModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('groupAtTimeModal'));
        modal.show();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('timestampInput').value = now.toISOString().slice(0,16);
    }

    async function viewGroupAtTime(groupName) {
        const timestamp = document.getElementById('timestampInput').value;
        if (!timestamp) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
            return;
        }
        
        try {
            const isoTimestamp = new Date(timestamp).toISOString();
            const response = await fetch(`/api/persistency/groups/${encodeURIComponent(groupName)}/at-time/?timestamp=${isoTimestamp}`);
            const data = await response.json();
            
            if (data.success) {
                displayGroupAtTimeModal(data.group_name, data.timestamp, data.members);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–∞–≤–∞ –≥—Ä—É–ø–ø—ã: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–∞–≤–∞ –≥—Ä—É–ø–ø—ã: ' + error.message);
        }
    }

    function displayGroupAtTimeModal(groupName, timestamp, members) {
        const formattedTime = new Date(timestamp).toLocaleString();
        
        let html = `
            <div class="modal fade" id="groupCompositionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"> –°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã ${groupName} –Ω–∞ ${formattedTime}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
        `;
        
        if (members.length === 0) {
            html += `<div class="alert alert-info">–ù–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≥—Ä—É–ø–ø–∞ ${groupName} –±—ã–ª–∞ –ø—É—Å—Ç–∞.</div>`;
        } else {
            html += `
                <div class="alert alert-success">
                    –í –≥—Ä—É–ø–ø–µ ${groupName} –Ω–∞ ${formattedTime} –±—ã–ª–æ <strong>${members.length}</strong> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–§–ò–û</th>
                                <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–ü–æ–ª</th>
                                <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                                <th>–ê–¥—Ä–µ—Å</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            members.forEach(member => {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è –∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                const nameParts = [member.last_name, member.first_name];
                if (member.middle_name) {
                    nameParts.push(member.middle_name);
                }
                const fullName = nameParts.join(' ');
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
                const birthDate = member.birth_date ? new Date(member.birth_date).toLocaleDateString() : '-';
                const gender = member.gender === '–ú' ? '–ú—É–∂—Å–∫–æ–π' : member.gender === '–ñ' ? '–ñ–µ–Ω—Å–∫–∏–π' : '-';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å –≤—Ä–µ–º–µ–Ω–µ–º
                const addedDate = member.created_at ? new Date(member.created_at).toLocaleString() : '-';
                
                html += `
                    <tr>
                        <td><strong>${fullName}</strong></td>
                        <td>${birthDate}</td>
                        <td>${gender}</td>
                        <td>${addedDate}</td>
                        <td>${member.phone || '-'}</td>
                        <td>${member.email || '-'}</td>
                        <td>${member.address || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('groupCompositionModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('groupCompositionModal'));
        modal.show();
    }

    // –§—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –∫–Ω–æ–ø–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç showGroupHistoryById
    // async function viewGroupHistory(groupName) {
    //     document.getElementById('groupIdInput').value = groupName;
    //     await showGroupHistoryModal();
    // }

    // –§—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ —É–±—Ä–∞–ª–∏ –∫–Ω–æ–ø–∫—É "–î–µ—Ç–∞–ª–∏"
    // async function viewChangesetDetails(changesetId) {
    //     ...
    // }

    function displayChangesetDetailsModal(details) {
        const formattedTime = new Date(details.changeset.timestamp).toLocaleString();
        
        let html = `
            <div class="modal fade" id="changesetDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üîç –î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>–í—Ä–µ–º—è:</strong> ${formattedTime}
                                </div>
                                <div class="col-md-6">
                                    <strong>–ê–≤—Ç–æ—Ä:</strong> <span class="badge bg-secondary">${details.changeset.author}</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${details.changeset.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}
                            </div>
        `;
        
        if (details.changes.length === 0) {
            html += `<div class="alert alert-info">–í —ç—Ç–æ–º changeset –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π.</div>`;
        } else {
            html += `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th>–ß–µ–ª–æ–≤–µ–∫</th>
                                <th>–ì—Ä—É–ø–ø–∞</th>
                                <th>–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            details.changes.forEach(change => {
                const actionBadge = change.action === 'add' ? 
                    '<span class="badge bg-success">–î–æ–±–∞–≤–ª–µ–Ω</span>' : 
                    '<span class="badge bg-danger">–£–¥–∞–ª–µ–Ω</span>';
                
                html += `
                    <tr>
                        <td>${actionBadge}</td>
                        <td>
                            <strong>${change.person.full_name}</strong><br>
                            <small class="text-muted">${change.person.phone}</small>
                        </td>
                        <td><span class="badge bg-primary">${change.group}</span></td>
                        <td>${new Date(change.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingModal = document.getElementById('changesetDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('changesetDetailsModal'));
        modal.show();
    }

    async function showGroupHistoryByIdFromInput() {
        const groupId = document.getElementById('groupIdInput').value.trim();
        if (!groupId) {
            alert('–í–≤–µ–¥–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã');
            return;
        }
        
        if (isNaN(groupId) || parseInt(groupId) < 1) {
            alert('ID –≥—Ä—É–ø–ø—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
            return;
        }
        
        await showGroupHistoryById(parseInt(groupId));
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü
    let sortDirection = {}; // –•—Ä–∞–Ω–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏
    
    function sortTable(columnIndex) {
        const table = document.querySelector('#resultsContainer table tbody');
        if (!table) return;
        
        const rows = Array.from(table.rows);
        const isAscending = !sortDirection[columnIndex];
        sortDirection[columnIndex] = isAscending;
        
        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex].textContent.trim();
            let bVal = b.cells[columnIndex].textContent.trim();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
            if (columnIndex === 0) { // ID - —á–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
            } else if (columnIndex === 1) { // –ì—Ä—É–ø–ø–∞ - —á–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
            } else if (columnIndex === 4) { // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
                aVal = new Date(aVal.split('.').reverse().join('-'));
                bVal = new Date(bVal.split('.').reverse().join('-'));
            } else if (columnIndex === 2) { // –§–ò–û - —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            if (aVal < bVal) return isAscending ? -1 : 1;
            if (aVal > bVal) return isAscending ? 1 : -1;
            return 0;
        });
        
        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        rows.forEach(row => table.appendChild(row));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        updateSortIcons(columnIndex, isAscending);
    }
    
    function sortSearchTable(columnIndex) {
        const table = document.querySelector('#resultsContainer .table-responsive table tbody');
        if (!table) return;
        
        const rows = Array.from(table.rows);
        const isAscending = !sortDirection['search_' + columnIndex];
        sortDirection['search_' + columnIndex] = isAscending;
        
        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex].textContent.trim();
            let bVal = b.cells[columnIndex].textContent.trim();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
            if (columnIndex === 0) { // –ì—Ä—É–ø–ø–∞ - —á–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
            } else if (columnIndex === 3) { // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
                aVal = new Date(aVal);
                bVal = new Date(bVal);
            } else if (columnIndex === 1) { // –§–ò–û - —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            if (aVal < bVal) return isAscending ? -1 : 1;
            if (aVal > bVal) return isAscending ? 1 : -1;
            return 0;
        });
        
        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        rows.forEach(row => table.appendChild(row));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        updateSearchSortIcons(columnIndex, isAscending);
    }
    
    function updateSortIcons(activeColumn, isAscending) {
        const headers = document.querySelectorAll('#resultsContainer table thead th');
        headers.forEach((header, index) => {
            const icon = header.querySelector('i');
            if (icon) {
                if (index === activeColumn) {
                    icon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    icon.className = 'fas fa-sort';
                }
            }
        });
    }
    
    function updateSearchSortIcons(activeColumn, isAscending) {
        const headers = document.querySelectorAll('#resultsContainer .table-responsive table thead th');
        headers.forEach((header, index) => {
            const icon = header.querySelector('i');
            if (icon) {
                if (index === activeColumn) {
                    icon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    icon.className = 'fas fa-sort';
                }
            }
        });
    }
</script>
{% endblock %}
