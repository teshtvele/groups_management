{% extends 'persons/base.html' %}

{% block title %}–í–∏—Ç—Ä–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ –∏ —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">üîç –í–∏—Ç—Ä–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ –ª—é–¥–µ–π</h2>
        
        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ü–æ–∏—Å–∫ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–¥–µ–¥—É–±–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)</h5>
            </div>
            <div class="card-body">
                <form id="searchForm" class="row g-3">
                    <div class="col-md-2">
                        <label for="last_name" class="form-label">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" 
                               placeholder="–ò–≤–∞–Ω–æ–≤...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="first_name" class="form-label">–ò–º—è</label>
                        <input type="text" class="form-control" id="first_name" name="first_name" 
                               placeholder="–ò–≤–∞–Ω...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="middle_name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                        <input type="text" class="form-control" id="middle_name" name="middle_name" 
                               placeholder="–ò–≤–∞–Ω–æ–≤–∏—á...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="address" class="form-label">–ê–¥—Ä–µ—Å</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="address" name="address" 
                                   placeholder="–ú–æ—Å–∫–≤–∞..." autocomplete="off">
                            <div id="search-address-suggestions" class="position-absolute w-100 bg-white border border-top-0 d-none" 
                                 style="z-index: 1000; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="form-control" id="phone" name="phone" 
                               placeholder="8915...">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" 
                               placeholder="@gmail.com">
                    </div>
                    
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-search"></i> –ü–æ–∏—Å–∫ –≤ –≤–∏—Ç—Ä–∏–Ω–µ
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearSearch()">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-info" onclick="showAllPersons()">
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö
                        </button>
                        <span id="resultsInfo" class="ms-3 text-muted"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫ -->
        <div id="loading" class="text-center d-none mb-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
        
        <div id="error" class="alert alert-danger d-none"></div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="resultsContainer">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤—Å–µ–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
            {% if persons %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</h5>
                    <span class="badge bg-info">–í—Å–µ–≥–æ: {{ persons|length }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>–ì—Ä—É–ø–ø–∞</th>
                                    <th>–§–ò–û</th>
                                    <th>–ü–æ–ª</th>
                                    <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>Email</th>
                                    <th>–°–æ–∑–¥–∞–Ω</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for person in persons %}
                                <tr>
                                    <td>{{ person.id }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ person.group.id }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ person.last_name }} {{ person.first_name }}</strong>
                                        {% if person.middle_name %} {{ person.middle_name }}{% endif %}
                                    </td>
                                    <td>
                                        {% if person.gender == '–ú' %}
                                            <span class="badge bg-info">–ú—É–∂—Å–∫–æ–π</span>
                                        {% else %}
                                            <span class="badge bg-warning">–ñ–µ–Ω—Å–∫–∏–π</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ person.birth_date|date:"d.m.Y" }}</td>
                                    <td>
                                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="{{ person.address }}">
                                            {{ person.address }}
                                        </div>
                                    </td>
                                    <td>{{ person.phone|default:"-" }}</td>
                                    <td>{{ person.email|default:"-" }}</td>
                                    <td>{{ person.created_at|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <h4>–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                <p>–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.</p>
                <a href="/create/" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞</a>
            </div>
            {% endif %}
        </div>
        
        <div class="mt-4">
            <a href="/" class="btn btn-outline-primary">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/create/" class="btn btn-outline-success">+ –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞</a>
        </div>
    </div>
</div>

<script>
    const searchForm = document.getElementById('searchForm');
    const resultsContainer = document.getElementById('resultsContainer');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const resultsInfo = document.getElementById('resultsInfo');

    // –ü–æ–∏—Å–∫ –≤ –≤–∏—Ç—Ä–∏–Ω–µ
    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadingDiv.classList.remove('d-none');
        errorDiv.classList.add('d-none');
        resultsInfo.textContent = '';
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = new FormData(searchForm);
        const params = new URLSearchParams();
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                params.append(key, value);
            }
        }
        
        try {
            const response = await fetch(`/api/persons/search/?${params.toString()}`);
            const data = await response.json();
            
            loadingDiv.classList.add('d-none');
            
            if (data.success) {
                displaySearchResults(data.data, data.count);
                resultsInfo.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${data.count} –¥–µ–¥—É–±–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`;
                resultsInfo.className = 'ms-3 text-success';
            } else {
                showError(data.errors || data.error);
            }
        } catch (error) {
            loadingDiv.classList.add('d-none');
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
        }
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    function displaySearchResults(results, count) {
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning text-center">
                    <h4>–ü–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö"</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ –≤–∏—Ç—Ä–∏–Ω–µ</h5>
                    <span class="badge bg-success">–ù–∞–π–¥–µ–Ω–æ: ${count}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>–ì—Ä—É–ø–ø–∞</th>
                                    <th>–§–ò–û</th>
                                    <th>–ü–æ–ª</th>
                                    <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>Email</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        results.forEach(person => {
            const fullName = `${person.last_name} ${person.first_name} ${person.middle_name || ''}`.trim();
            const genderBadge = person.gender === '–ú' ? 
                '<span class="badge bg-info">–ú—É–∂—Å–∫–æ–π</span>' : 
                '<span class="badge bg-warning">–ñ–µ–Ω—Å–∫–∏–π</span>';
            
            html += `
                <tr>
                    <td><span class="badge bg-primary">${person.group_id}</span></td>
                    <td><strong>${fullName}</strong></td>
                    <td>${genderBadge}</td>
                    <td>${person.birth_date}</td>
                    <td>
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${person.address}">
                            ${person.address}
                        </div>
                    </td>
                    <td>${person.phone || '-'}</td>
                    <td>${person.email || '-'}</td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        resultsContainer.innerHTML = html;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
    function showAllPersons() {
        location.reload();
    }

    // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ–∏—Å–∫–∞
    function clearSearch() {
        searchForm.reset();
        resultsInfo.textContent = '';
        resultsInfo.className = 'ms-3 text-muted';
        errorDiv.classList.add('d-none');
        location.reload();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(error) {
        errorDiv.classList.remove('d-none');
        if (typeof error === 'object') {
            let errorText = '–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\\n';
            for (let field in error) {
                errorText += `${field}: ${error[field].join(', ')}\\n`;
            }
            errorDiv.textContent = errorText;
        } else {
            errorDiv.textContent = error;
        }
        resultsInfo.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ';
        resultsInfo.className = 'ms-3 text-danger';
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –≤ —Ñ–æ—Ä–º–µ –ø–æ–∏—Å–∫–∞
    let searchAddressTimeout;
    const searchAddressInput = document.getElementById('address');
    const searchSuggestionsDiv = document.getElementById('search-address-suggestions');

    if (searchAddressInput) {
        searchAddressInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchAddressTimeout);
            
            if (query.length < 3) {
                hideSearchSuggestions();
                return;
            }
            
            searchAddressTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/address/suggestions/?query=${encodeURIComponent(query)}&count=5`);
                    const data = await response.json();
                    
                    if (data.success && data.suggestions.length > 0) {
                        showSearchSuggestions(data.suggestions);
                    } else {
                        hideSearchSuggestions();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∞–¥—Ä–µ—Å–∞:', error);
                    hideSearchSuggestions();
                }
            }, 300);
        });

        // –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
        document.addEventListener('click', function(e) {
            if (!searchAddressInput.contains(e.target) && !searchSuggestionsDiv.contains(e.target)) {
                hideSearchSuggestions();
            }
        });
    }

    function showSearchSuggestions(suggestions) {
        let html = '';
        suggestions.forEach((suggestion) => {
            html += `
                <div class="search-suggestion-item p-2 border-bottom cursor-pointer" 
                     style="cursor: pointer;"
                     onmouseover="this.style.backgroundColor='#f8f9fa'"
                     onmouseout="this.style.backgroundColor='white'"
                     onclick="selectSearchAddress('${suggestion.value.replace(/'/g, "\\'")}')">
                    <div>${suggestion.value}</div>
                </div>
            `;
        });
        
        searchSuggestionsDiv.innerHTML = html;
        searchSuggestionsDiv.classList.remove('d-none');
    }

    function selectSearchAddress(address) {
        searchAddressInput.value = address;
        hideSearchSuggestions();
    }

    function hideSearchSuggestions() {
        searchSuggestionsDiv.classList.add('d-none');
    }
</script>
{% endblock %}
